# hubotとslackで自動化生活はじめよう

##

TODO この辺はhubotの基礎

---

## 自作のhubotを運用
クラウドサービスで動かすのが前提(Heroku等)。

---

## hubot
[画像]

---

## Slack
[画像]

---

## 連携させると強い
* hubot単体だと(コンソールでしか)話しかけられない
* ところがSlackと連携させるとたちまち最強になる
    * Slackにはルーム以外にbotを設定できる
* 特定のワード(正規表現)に反応して処理を実行できる
* いわゆる**ChatOps**

---

## hubotはCoffeeScript
CoffeeScriptで書く必要がある
基本的にはJavaScriptとほとんど同じ

---

## Ruboty
* hubotと同じようなことができる
* CoffeeScriptではなくRubyで書ける
* ただし、プラグインがかなり少ない
* メンテが期待できない(個人開発)

初めはRubotyで考えていたが、やはりGithub製のhubotを採用

---

## 自分だけのbotを作る
* どうせなら自分好みのbotに仕上げる

---

## mika4
* https://github.com/mapserver2007/mika4
* 自作hubot
    * 電車遅延状況を教える(trechin)
    * herokuアプリの起動/停止/再起動をする(heroku_operation)

---

## Herokuアプリでの運用の悩み

* メモリリークする(直せよ…)
* HerokuのFreeプランは512MBを超えるとログにアラートを吐きつづける
* 1024MBで強制停止
* 再起動すればとりあえず直るが…

---

## 再起動までのハードル

* Herokuアプリをデプロイしているマシンでないと再起動できない
* 再起動用のAPIがない
* つまり自宅以外だとスマホでリモートログインしてコマンドを叩くことに
* 正直やってられない…

---

## herokuアプリをSlack経由で操作
せや、Slack経由でやればいいんや！

---

## APIがないのにどうやって再起動するのか
* いずれにせよリモートから操作する必要がある(主にスマホ)
* SSH? RDP? (ヾﾉ･∀･`)ﾅｲﾅｲ
* この程度でルータに穴あけしたくない…

---

## 初心に立ち返ろう
我々には**メール**がある！

---

## メールをトリガにしてシェルスクリプトを叩く
* メールを受信したらHeroku再起動コマンドを実行するシェルスクリプトを実行する
* メーラがあれば可能

---

## 構成
* Slackに「◯◯再起動してちょ」と話しかける
* Slack→hubotを叩く
* hubotはメールを送信
* Macで受信、受信後AppleScriptを実行
* AppleScriptはシェルスクリプトを実行
* シェルスクリプトはRubyスクリプトを実行
* RubyスクリプトはHerokuコマンドを実行
* 成功時にMongoDB(mlab)に結果を書き込む
* hubotはMongoDBを一定時間監視、成功していれば結果が更新
* 更新を検知したら結果をSlackに返す

---

## デモ

---

## まとめ
* 簡単なものはCoffee内で十分
* 複雑なものは別なものを用意するのもあり
    * めんどくさかったので得意なRubyに任せた
* これからの流行りはChatOps
    * 自動化の基点はSlack+hubot
* hubotでgithub検索すると死ぬほどあるので組み合わせるといい感じ
    * ただしほとんど英語
    * 日本語風会話したければ要カスタマイズ
