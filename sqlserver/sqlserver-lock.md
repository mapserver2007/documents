# SQLServer ロックについて

## 共有ロック
[https://msdn.microsoft.com/ja-jp/library/JJ856598(v=SQL.120).aspx](https://msdn.microsoft.com/ja-jp/library/JJ856598(v=SQL.120).aspx)  
(共有ロックの欄参照)

```
共有ロック
共有 (S) ロックを設定すると、同時に実行されている複数のトランザクションがペシミスティック同時実行制御の下でリソースの読み取り (SELECT) を行います。他のトランザクションは、リソースに共有 (S) ロックがかけられている間はデータを変更できません。リソースにかけられている共有 (S) ロックは、読み取りが完了するとすぐに解除されます。ただし、トランザクションの分離レベルが REPEATABLE READ 以上に設定されている場合や、トランザクションの間、ロック ヒントを使用して共有 (S) ロックを保つ場合を除きます。
```

共有ロックは、ロックヒント無しでSELECTしたときにかかる。  
共有ロックは、更新させないためのロック。SELECTが終わったら即座に解除。

## 3つのロックまとめ(共有、排他、更新)
[http://www.atmarkit.co.jp/fdotnet/entwebapp/entwebapp09/entwebapp09_01.html](http://www.atmarkit.co.jp/fdotnet/entwebapp/entwebapp09/entwebapp09_01.html)

```
・ 共有ロック（Share Lock, S-Lock）
	・ 自分がそのデータを読み出していることを、他のユーザに示すために立てるフラグ。

・ 更新ロック（Update Lock, U-Lock）
	・ 自分がそのデータを後で更新する予定であることを、他のユーザに示すために立てるフラグ。

・ 排他ロック（eXclusive Lock, X-Lock）
	・ 自分がそのデータを更新していることを、他のユーザに示すために立てるフラグ。
```

排他ロックは、更新処理時にかけるロック。他のトランザクションからのSELECT(共有ロック)は不可能。
更新ロックは、更新処理時にかけるロック。他のトランザクションからのSELECT(共有ロック)は可能。

## ダーティリード時の欠落または重複
[https://support.microsoft.com/ja-jp/kb/975782](https://support.microsoft.com/ja-jp/kb/975782)

```
Microsoft SQL Server で、"READ UNCOMMITTED 分離レベル" または "NOLOCK ヒント" を使用した SQL 文を実行してデータを参照すると、読み取ったデータの行が欠落、または重複する場合があります。

たとえば、次のような状況で行の重複や欠落が発生します。

"READ UNCOMMITTED 分離レベル" で実行されるトランザクションや "NOLOCK ヒント" を使用した読み取りではロックが取得されないため、インデックスをスキャンしている時にページ分割が実行されても、そのページ分割中のページ内の行を読み取ることができます。そして、それらページ内のどの行まで読み取ったか、また、どの行がページ分割により新たなページへ移動されるかが関連し、その行が再び出現するか (重複)、もしくは出現しない (欠落) 可能性があります。

なお、"READ COMMITTED 分離レベル" を使用した場合は、この現象は発生しません。
```

### 関連：ページ分割
[http://mtgsqlserver.blogspot.jp/2013/03/blog-post_4156.html](http://mtgsqlserver.blogspot.jp/2013/03/blog-post_4156.html)

```
デフォルトでは、ページ内は、追加または更新されたデータによって満杯に埋まっています。この状態で、間に割り込む値が追加されると、「ページ分割」が発生します。

(中略)

この動作（ページ分割）は、インデックスが常に昇順に並べ替えられた状態に保たれている必要があるために行われています。間に割り込む値が追加されると、その値によって溢れ出たデータを格納するための新しいページが必要になるのです。
```

WITH(NOLOCK)を使ったSELECT中にページ分割が発生した場合、本来ロックがかかり、その間は読まれないのが普通だが、ダーティリードできるので、分割中に読み込めることが原因でデータが欠落また重複することがある。同一テーブルに対して同時に参照と更新がかかるケースでは避けなければならない。DBをマスタ、スレーブで分けていれば気にすることはない。バッチで刈り取る系の処理の場合発生する。
